/*! coreBuilder 2013-12-29 */
(function(){var root,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};root=this,root.coreBuilder={},function($,coreBuilder,_,Backbone,ace){var Core,CoreEntry,CoreEntryView,CoreView,Editor,EditorView,Editors,EditorsView,Selection,SelectionGroup,SelectionGroupView,SelectionView,Source,Sources,_ref,_ref1,_ref10,_ref11,_ref12,_ref13,_ref14,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;return coreBuilder.Utils={},coreBuilder.Utils.generateUid=function(separator){var S4,delim;return delim=null!=separator?separator:"-",S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},S4()+S4()+delim+S4()+delim+S4()+delim+S4()+delim+S4()+S4()+S4()},coreBuilder.Components={},coreBuilder.Components.FileInput=function(){return $("input[type=file]").bootstrapFileInput()},coreBuilder.Components.SourceSelector=function(target){return $(target).multiselect({buttonClass:"btn",buttonWidth:"auto",buttonContainer:'<div class="btn-group" />',maxHeight:!1,onChange:function(opt,adding){var editor,s,source,url;return source=$(opt).val(),adding?(url="data/"+source+".xml",editor=coreBuilder.Data.Editors.add({source:source,url:url}),$.get(url,function(data){var parser,xmlDoc;return parser=new DOMParser,xmlDoc=parser.parseFromString(data,"text/xml"),editor.set({text:data,xmldata:xmlDoc})},"text")):(s=coreBuilder.Data.Editors.get(source),coreBuilder.Data.Editors.remove(source),s.trigger("destroy"))},buttonText:function(options){var sel;return sel=[],options.length>0&&options.each(function(){var source_id;return source_id=$(this).text(),sel.push(source_id)}),0===sel.length?'Sources <b class="caret"></b>':sel.join(", ")+' <b class="caret"></b>'}})},coreBuilder.Data={},Editor=function(_super){function Editor(){return _ref=Editor.__super__.constructor.apply(this,arguments)}return __extends(Editor,_super),Editor.prototype.idAttribute="source",Editor.prototype.initialize=function(){return this.selectionGroup=new SelectionGroup},Editor}(Backbone.Model),CoreEntry=function(_super){function CoreEntry(){return _ref1=CoreEntry.__super__.constructor.apply(this,arguments)}return __extends(CoreEntry,_super),CoreEntry}(Backbone.Model),Source=function(_super){function Source(){return _ref2=Source.__super__.constructor.apply(this,arguments)}return __extends(Source,_super),Source}(Backbone.Model),Selection=function(_super){function Selection(){return _ref3=Selection.__super__.constructor.apply(this,arguments)}return __extends(Selection,_super),Selection.prototype.idAttribute="xmlid",Selection}(Backbone.Model),Editors=function(_super){function Editors(){return _ref4=Editors.__super__.constructor.apply(this,arguments)}return __extends(Editors,_super),Editors.prototype.model=Editor,Editors}(Backbone.Collection),Sources=function(_super){function Sources(){return _ref5=Sources.__super__.constructor.apply(this,arguments)}return __extends(Sources,_super),Sources.prototype.model=Source,Sources}(Backbone.Collection),SelectionGroup=function(_super){function SelectionGroup(){return _ref6=SelectionGroup.__super__.constructor.apply(this,arguments)}return __extends(SelectionGroup,_super),SelectionGroup.prototype.model=Selection,SelectionGroup}(Backbone.Collection),Core=function(_super){function Core(){return _ref7=Core.__super__.constructor.apply(this,arguments)}return __extends(Core,_super),Core.prototype.model=CoreEntry,Core}(Backbone.Collection),coreBuilder.Data.Editors=new Editors,coreBuilder.Data.Core=new Core,coreBuilder.Views={},SelectionGroupView=function(_super){function SelectionGroupView(){return _ref8=SelectionGroupView.__super__.constructor.apply(this,arguments)}return __extends(SelectionGroupView,_super),SelectionGroupView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"remove",this.removeOne)},SelectionGroupView.prototype.addOne=function(m){return this.$el.append(new SelectionView({model:m}).render().el),this},SelectionGroupView.prototype.removeOne=function(m){var id;return null==m.get("empty")&&(id="#sel_"+m.id.replace(/\"/g,""),$(id).remove()),this},SelectionGroupView}(Backbone.View),SelectionView=function(_super){function SelectionView(){return this.removeOne=__bind(this.removeOne,this),_ref9=SelectionView.__super__.constructor.apply(this,arguments)}return __extends(SelectionView,_super),SelectionView.prototype.tagName="span",SelectionView.prototype.template=_.template($("#selection-tpl").html()),SelectionView.prototype.events={"click .sel-remove":"removeOne"},SelectionView.prototype.removeOne=function(){return this.model.collection.remove(this.model.id,{silent:!1})},SelectionView.prototype.render=function(){var id;return null==this.model.get("empty")&&(this.$el.addClass("badge"),id="sel_"+this.model.id.replace(/\"/g,""),this.$el.attr("id",id),this.$el.html(this.template(this.model.toJSON()))),this},SelectionView}(Backbone.View),EditorView=function(_super){function EditorView(){return _ref10=EditorView.__super__.constructor.apply(this,arguments)}return __extends(EditorView,_super),EditorView.prototype.template=_.template($("#editor-tpl").html()),EditorView.prototype.initialize=function(){return this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},EditorView.prototype.tagName="div",EditorView.prototype.events={"click .add-empty":"addEmpty"},EditorView.prototype.addEmpty=function(e){var _this=this;return this.model.selectionGroup.each(function(s){return _this.model.selectionGroup.remove(s)}),$(e.target).addClass("disabled"),this.model.selectionGroup.add({empty:!0}),this.listenTo(this.model.selectionGroup,"remove",function(m){return null!=m.get("empty")?$(e.target).removeClass("disabled"):void 0})},EditorView.prototype.bindSelect=function(){var _this=this;return $(this.editor.container).click(function(e){var find_q,popup,pos,tagName,token,tokenRow,xmldata,xmlel,xmlid;if(e.stopPropagation(),$("#el_select").remove(),pos=_this.editor.getCursorPosition(),token=_this.editor.session.getTokenAt(pos.row,pos.column),tokenRow=_this.editor.session.getTokens(pos.row),null!=token)switch(!1){case!("entity.other.attribute-name"===token.type&&"xml:id"===token.value):xmlid=tokenRow[token.index+2].value;break;case!("string"===token.type&&"xml:id"===tokenRow[token.index-2].value):xmlid=token.value}return null!=xmlid?(xmldata=$(_this.model.get("xmldata")),find_q="*[xml\\:id="+xmlid+"]",xmlel=xmldata.find(find_q),tagName=xmlel.prop("tagName"),popup=$('<button type="button" class="btn btn-default" id="el_select">'+tagName+"</button>"),popup.css({position:"absolute",left:e.pageX,top:e.pageY,"z-index":999}),$("html").append(popup),popup.click(function(e){return e.stopPropagation(),_this.model.selectionGroup.add({ident:tagName,xmlid:xmlid,pos:pos}),popup.remove()})):void 0})},EditorView.prototype.render=function(){var $el;return $el=$(this.el),$el.html(this.template(this.model.toJSON())),$("#editors").append($el),this.editor=ace.edit("ed_"+this.model.get("source")),this.editor.setReadOnly(!0),this.editor.setTheme("ace/theme/monokai"),this.editor.getSession().setMode("ace/mode/xml"),this.editor.getSession().insert({column:0,row:0},this.model.get("text")),this.editor.moveCursorTo({column:0,row:0}),this.bindSelect(),$el.append(new SelectionGroupView({collection:this.model.selectionGroup}).el)},EditorView.prototype.remove=function(){return $(this.el).remove(),this},EditorView}(Backbone.View),EditorsView=function(_super){function EditorsView(){return _ref11=EditorsView.__super__.constructor.apply(this,arguments)}return __extends(EditorsView,_super),EditorsView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.addOne)},EditorsView.prototype.addOne=function(model){return new EditorView({model:model})},EditorsView}(Backbone.View),CoreEntryView=function(_super){function CoreEntryView(){return _ref12=CoreEntryView.__super__.constructor.apply(this,arguments)}return __extends(CoreEntryView,_super),CoreEntryView.prototype.el="#cur_entry",CoreEntryView.prototype.template=_.template($("#core-tpl").html()),CoreEntryView.prototype.events={"click #entry_add":"addEntry","click #entry_cancel":"remove"},CoreEntryView.prototype.addEntry=function(){var msg;return coreBuilder.Data.Core.add({entry:this.toXMLString(),formatted:this.toXMLString(!0)}),this.remove(),msg=$('<div class="alert alert-success fade in">Added!</div>'),this.$el.html(msg),$(msg).alert(),window.setTimeout(function(){return $(msg).alert("close")},500)},CoreEntryView.prototype.toXMLString=function(format){var indent,nl,p,r,xml_string,_i,_j,_len,_len1,_ref13,_ref14,_ref15,_ref16;for(null==format&&(format=!1),nl="\n",indent="  ",xml_string="<app>",_ref13=this.collection.models,_i=0,_len=_ref13.length;_len>_i;_i++)if(r=_ref13[_i],(null!=(_ref14=r.selectionGroup)?_ref14.length:void 0)>0){for(format&&(xml_string+=nl+indent),xml_string+='<rdg wit="'+r.get("source")+">",_ref15=r.selectionGroup.models,_j=0,_len1=_ref15.length;_len1>_j;_j++)p=_ref15[_j],format&&(xml_string+=nl+indent+indent),null!=p.get("empty")&&(xml_string+="<!-- empty -->"),(null!=(_ref16=p.get("xmlid"))?_ref16.length:void 0)>0&&(xml_string+='<ptr target="'+p.get("xmlid")+"/>");format&&(xml_string+=nl+indent),xml_string+="</rdg>"}return format&&(xml_string+=nl),xml_string+="</app>"},CoreEntryView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.addOne),this},CoreEntryView.prototype.addOne=function(model){return this.listenTo(model.selectionGroup,"add",this.render),this.listenTo(model.selectionGroup,"remove",this.render),this},CoreEntryView.prototype.render=function(){var xml_string;return xml_string=this.toXMLString(!0),xml_string=xml_string.replace(/</g,"&lt;"),xml_string=xml_string.replace(/>/g,"&gt;"),this.$el.html(this.template({xml_string:xml_string})),this},CoreEntryView.prototype.remove=function(){return this.collection.each(function(c){return c.selectionGroup.each(function(s){return c.selectionGroup.remove(s)})}),this.$el.empty(),this},CoreEntryView}(Backbone.View),CoreView=function(_super){function CoreView(){return _ref13=CoreView.__super__.constructor.apply(this,arguments)}return __extends(CoreView,_super),CoreView.prototype.tagName="pre",CoreView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this},CoreView.prototype.render=function(){var _this=this;return this.$el.empty(),this.collection.each(function(entry){var xml_string;return xml_string=entry.get("formatted"),xml_string=xml_string.replace(/</g,"&lt;"),xml_string=xml_string.replace(/>/g,"&gt;"),xml_string+="\n",_this.$el.append(xml_string)}),$("#coreModal .modal-body").html(this.$el)},CoreView}(Backbone.View),coreBuilder.App=function(_super){function App(){return _ref14=App.__super__.constructor.apply(this,arguments)}return __extends(App,_super),App.prototype.el="#coreBuilder",App.prototype.initialize=function(){return coreBuilder.Components.SourceSelector(".sel-sources"),coreBuilder.Components.FileInput(),new EditorsView({collection:coreBuilder.Data.Editors}),new CoreEntryView({collection:coreBuilder.Data.Editors}),new CoreView({collection:coreBuilder.Data.Core})},App}(Backbone.View)}(jQuery,coreBuilder,_,Backbone,ace)}).call(this);